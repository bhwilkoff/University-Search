<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Search Platform</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.8rem; margin-bottom: 10px; text-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
        .header p { font-size: 1.1rem; }
        .search-panel { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #667eea, #764ba2); color: white; margin: 5px; transition: transform 0.2s, box-shadow 0.2s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .btn-special { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: #333; }
        .content-area { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 600px; }
        .results-panel { background: white; border-radius: 15px; padding: 20px; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .map-panel { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #map { height: 100%; width: 100%; }
        .university-card { background: #f8fafc; border-radius: 10px; padding: 20px; margin-bottom: 15px; cursor: pointer; border-left: 5px solid #667eea; transition: all 0.2s ease-in-out; }
        .university-card:hover { transform: translateX(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-left-color: #764ba2; }
        .university-card h4 { color: #667eea; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); animation: fadeIn 0.3s; }
        .modal-content { background-color: white; margin: 5% auto; padding: 30px; border-radius: 10px; width: 80%; max-width: 800px; max-height: 80vh; overflow-y: auto; animation: slideIn 0.3s; }
        .close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; color: #888; }
        .close:hover { color: #000; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
        .filter-section { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .filter-section:last-child { border-bottom: none; }
        .filter-section h3 { margin-bottom: 15px; color: #333; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 20px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; }
        .checkbox-item label { font-weight: normal; }
        .detail-section { margin-top: 20px; }
        .detail-section h3 { color: #764ba2; border-bottom: 2px solid #764ba2; padding-bottom: 5px; margin-bottom: 10px; }
        .detail-section p { margin-bottom: 8px; line-height: 1.4; }
        .detail-section small { color: #555; }
        .match-badge { padding: 4px 10px; border-radius: 20px; color: white; font-size: 0.8rem; font-weight: bold; }
        .match-perfect { background-color: #28a745; }
        .match-strong { background-color: #007bff; }
        .match-good { background-color: #6f42c1; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-50px); } to { transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>University Search Platform</h1>
            <p>Find the perfect college for your academic journey using live data from the U.S. Department of Education</p>
        </div>

        <div class="search-panel">
             <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn btn-special" onclick="applyMyPreferences()"><i class="fas fa-magic"></i> Find My Perfect School</button>
             </div>

             <div class="filter-section">
                <h3><i class="fas fa-university"></i> Basic Info</h3>
                <div class="filter-grid">
                    <div class="form-group">
                        <label for="name">University Name</label>
                        <input type="text" id="name" placeholder="Search by name...">
                    </div>
                    <div class="form-group">
                        <label for="state">State</label>
                        <select id="state">
                            <option value="">All States</option>
                            <option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option><option value="AR">Arkansas</option><option value="CA">California</option><option value="CO">Colorado</option><option value="CT">Connecticut</option><option value="DE">Delaware</option><option value="FL">Florida</option><option value="GA">Georgia</option><option value="HI">Hawaii</option><option value="ID">Idaho</option><option value="IL">Illinois</option><option value="IN">Indiana</option><option value="IA">Iowa</option><option value="KS">Kansas</option><option value="KY">Kentucky</option><option value="LA">Louisiana</option><option value="ME">Maine</option><option value="MD">Maryland</option><option value="MA">Massachusetts</option><option value="MI">Michigan</option><option value="MN">Minnesota</option><option value="MS">Mississippi</option><option value="MO">Missouri</option><option value="MT">Montana</option><option value="NE">Nebraska</option><option value="NV">Nevada</option><option value="NH">New Hampshire</option><option value="NJ">New Jersey</option><option value="NM">New Mexico</option><option value="NY">New York</option><option value="NC">North Carolina</option><option value="ND">North Dakota</option><option value="OH">Ohio</option><option value="OK">Oklahoma</option><option value="OR">Oregon</option><option value="PA">Pennsylvania</option><option value="RI">Rhode Island</option><option value="SC">South Carolina</option><option value="SD">South Dakota</option><option value="TN">Tennessee</option><option value="TX">Texas</option><option value="UT">Utah</option><option value="VT">Vermont</option><option value="VA">Virginia</option><option value="WA">Washington</option><option value="WV">West Virginia</option><option value="WI">Wisconsin</option><option value="WY">Wyoming</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="city">City</label>
                        <input type="text" id="city" placeholder="City name...">
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <h3><i class="fas fa-graduation-cap"></i> Academic & Selectivity</h3>
                 <div class="filter-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                    <div class="form-group">
                        <label for="minEnroll">Min Enrollment</label>
                        <input type="number" id="minEnroll" placeholder="15000">
                    </div>
                    <div class="form-group">
                        <label for="maxEnroll">Max Enrollment</label>
                        <input type="number" id="maxEnroll" placeholder="50000">
                    </div>
                    <div class="form-group">
                        <label for="maxAccept">Max Acceptance Rate (%)</label>
                        <input type="number" id="maxAccept" placeholder="50" max="100">
                    </div>
                    <div class="form-group">
                        <label for="minSat">Min SAT Score</label>
                        <input type="number" id="minSat" placeholder="1200" max="1600">
                    </div>
                </div>
            </div>

             <div class="filter-section">
                <h3><i class="fas fa-dollar-sign"></i> Cost Considerations</h3>
                 <div class="filter-grid">
                    <div class="form-group">
                        <label for="maxTuitionIn">Max In-State Tuition</label>
                        <input type="number" id="maxTuitionIn" placeholder="15000">
                    </div>
                    <div class="form-group">
                        <label for="maxTuitionOut">Max Out-of-State Tuition</label>
                        <input type="number" id="maxTuitionOut" placeholder="35000">
                    </div>
                    <div class="form-group">
                        <label for="maxTotalCost">Max Total Cost (Out-of-State)</label>
                        <input type="number" id="maxTotalCost" placeholder="50000">
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <h3><i class="fas fa-map-marker-alt"></i> Location & Setting</h3>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="coastal"><label for="coastal">Coastal Location</label>
                    </div>
                     <div class="checkbox-item">
                        <input type="checkbox" id="urban"><label for="urban">Urban Setting</label>
                    </div>
                     <div class="checkbox-item">
                        <input type="checkbox" id="suburban"><label for="suburban">Suburban Setting</label>
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <h3><i class="fas fa-book"></i> Academic Programs</h3>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="business"><label for="business">Business/Real Estate</label>
                    </div>
                     <div class="checkbox-item">
                        <input type="checkbox" id="politicalScience"><label for="politicalScience">Political Science</label>
                    </div>
                     <div class="checkbox-item">
                        <input type="checkbox" id="preLaw"><label for="preLaw">Pre-Law</label>
                    </div>
                </div>
            </div>
            
            <button class="btn" onclick="search()">Search Universities</button>
            <button class="btn" onclick="clearFilters()">Clear Filters</button>
        </div>

        <div class="content-area">
            <div class="results-panel" id="results-panel">
                <div class="sort-container" style="display: none; padding-bottom: 15px; margin-bottom: 15px; border-bottom: 1px solid #eee;">
                    <label for="sort-by" style="font-weight: bold; margin-right: 10px;">Sort by:</label>
                    <select id="sort-by" onchange="sortResults()" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                        <option value="matchScore">Best Match</option>
                        <option value="name">University Name (A-Z)</option>
                        <option value="acceptanceLow">Acceptance Rate (Lowest First)</option>
                        <option value="satHigh">Avg SAT Score (Highest First)</option>
                        <option value="costLow">Total Cost (Lowest First)</option>
                        <option value="costHigh">Total Cost (Highest First)</option>
                        <option value="enrollmentHigh">Enrollment (Largest First)</option>
                    </select>
                </div>
                <div id="results">
                    <p>Use the filters above and click "Search Universities" to find schools.</p>
                </div>
            </div>
            <div class="map-panel">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var map;
        var markersLayer = L.layerGroup();
        var results = [];
        var latestYear;
        const API_KEY = 'xjCQ2aaKTOw5zAE8GIcqmxE3V17CxAmphXowVWMo';
        const coastalStates = ['CA', 'OR', 'WA', 'TX', 'LA', 'MS', 'AL', 'GA', 'FL', 'SC', 'NC', 'VA', 'MD', 'DE', 'NJ', 'NY', 'CT', 'RI', 'MA', 'NH', 'ME', 'AK', 'HI'];

        function applyMyPreferences() {
            document.getElementById('minEnroll').value = '15000';
            document.getElementById('maxEnroll').value = '50000';
            document.getElementById('maxAccept').value = '50';
            document.getElementById('coastal').checked = true;
            document.getElementById('urban').checked = true;
            document.getElementById('suburban').checked = true;
            document.getElementById('business').checked = true;
            document.getElementById('politicalScience').checked = true;
            document.getElementById('preLaw').checked = true;
            search();
        }

        async function search() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>Searching for universities...</p>';

            // Basic Info
            const name = document.getElementById('name').value;
            const state = document.getElementById('state').value;
            const city = document.getElementById('city').value;
            
            // Academic & Selectivity
            const minEnroll = document.getElementById('minEnroll').value;
            const maxEnroll = document.getElementById('maxEnroll').value;
            const maxAccept = document.getElementById('maxAccept').value;
            const minSat = document.getElementById('minSat').value;

            // Cost Considerations
            const maxTuitionIn = document.getElementById('maxTuitionIn').value;
            const maxTuitionOut = document.getElementById('maxTuitionOut').value;
            const maxTotalCost = document.getElementById('maxTotalCost').value;

            // Location & Setting
            const isCoastal = document.getElementById('coastal').checked;
            const isUrban = document.getElementById('urban').checked;
            const isSuburban = document.getElementById('suburban').checked;

            // Academic Programs
            const hasBusiness = document.getElementById('business').checked;
            const hasPoliSci = document.getElementById('politicalScience').checked;
            const hasPreLaw = document.getElementById('preLaw').checked;

            const fields = [
                'id', 'school.name', 'school.city', 'school.state', 'school.school_url',
                'school.locale', 'school.ownership',
                'location.lat', 'location.lon',
                'latest.student.size',
                'latest.admissions.admission_rate.overall',
                'latest.admissions.sat_scores.average.overall',
                'latest.cost.tuition.in_state', 'latest.cost.tuition.out_of_state',
                'latest.cost.booksupply', 'latest.cost.roomboard.oncampus', 'latest.cost.other.oncampus',
                'latest.completion.rate_suppressed.overall',
                'latest.earnings.6_yrs_after_entry.median',
                'latest.academics.program_percentage.business_marketing',
                'latest.academics.program_percentage.social_science',
                'latest.academics.program_percentage.legal',
                'latest.academics.program_percentage.humanities'
            ].join(',');

            let params = new URLSearchParams({
                'api_key': API_KEY, 'fields': fields, '_per_page': 100,
                'school.operating': '1', 'school.degrees_awarded.predominant': '3'
            });

            if (name) params.append('school.name', name);
            if (state) params.append('school.state', state);
            if (city) params.append('school.city', city);
            
            let minEnrollVal = parseInt(minEnroll) || 0;
            let maxEnrollVal = maxEnroll ? parseInt(maxEnroll) : '';
            if (maxEnrollVal) {
                 params.append('latest.student.size__range', `${minEnrollVal}..${maxEnrollVal}`);
            } else if (minEnroll) {
                 params.append('latest.student.size__range', `${minEnrollVal}..`);
            }
           
            if (maxAccept) {
                params.append('latest.admissions.admission_rate.overall__range', `0..${parseFloat(maxAccept) / 100}`);
            }
            if (minSat) {
                params.append('latest.admissions.sat_scores.average.overall__range', `${parseInt(minSat)}..`);
            }
            if (maxTuitionIn) {
                params.append('latest.cost.tuition.in_state__range', `0..${parseInt(maxTuitionIn)}`);
            }
            if (maxTuitionOut) {
                params.append('latest.cost.tuition.out_of_state__range', `0..${parseInt(maxTuitionOut)}`);
            }
            if (isUrban || isSuburban) {
                let locales = [];
                if (isUrban) locales.push(11, 12, 13);
                if (isSuburban) locales.push(21, 22, 23);
                params.append('school.locale', locales.join(','));
            }

            try {
                const response = await fetch(`https://api.data.gov/ed/collegescorecard/v1/schools.json?${params.toString()}`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    const message = errorData?.error?.message || response.statusText || 'An unknown error occurred';
                    throw new Error(`API request failed with status ${response.status}: ${message}`);
                }
                const data = await response.json();
                
                latestYear = data.metadata.latest_year;

                let processedResults = data.results.map(uni => {
                    const tuitionIn = uni['latest.cost.tuition.in_state'];
                    const tuitionOut = uni['latest.cost.tuition.out_of_state'];
                    const roomBoard = uni['latest.cost.roomboard.oncampus'];
                    const books = uni['latest.cost.booksupply'];
                    const other = uni['latest.cost.other.oncampus'];
                    const nonTuitionCosts = (roomBoard || 0) + (books || 0) + (other || 0);

                    return {
                        name: uni['school.name'],
                        location: `${uni['school.city']}, ${uni['school.state']}`,
                        state: uni['school.state'],
                        lat: uni['location.lat'],
                        lng: uni['location.lon'],
                        enrollment: uni['latest.student.size'],
                        acceptance: uni['latest.admissions.admission_rate.overall'],
                        sat: uni['latest.admissions.sat_scores.average.overall'],
                        tuitionIn: tuitionIn,
                        tuitionOut: tuitionOut,
                        totalCostInState: tuitionIn !== null ? tuitionIn + nonTuitionCosts : null,
                        totalCostOutState: tuitionOut !== null ? tuitionOut + nonTuitionCosts : null,
                        website: uni['school.school_url'],
                        locale: uni['school.locale'],
                        ownership: uni['school.ownership'],
                        gradRate: uni['latest.completion.rate_suppressed.overall'],
                        medianEarnings: uni['latest.earnings.6_yrs_after_entry.median'],
                        programs: {
                            'Business & Marketing': uni['latest.academics.program_percentage.business_marketing'],
                            'Social Sciences': uni['latest.academics.program_percentage.social_science'],
                            'Legal Professions': uni['latest.academics.program_percentage.legal'],
                            'Humanities': uni['latest.academics.program_percentage.humanities']
                        }
                    };
                }).filter(uni => uni.lat && uni.lng);

                // CLIENT-SIDE FILTERING for complex/calculated fields
                if (isCoastal) {
                    processedResults = processedResults.filter(uni => coastalStates.includes(uni.state));
                }
                if (maxTotalCost) {
                    processedResults = processedResults.filter(uni => uni.totalCostOutState && uni.totalCostOutState <= parseInt(maxTotalCost));
                }
                if (hasBusiness) {
                    processedResults = processedResults.filter(uni => uni.programs['Business & Marketing'] > 0);
                }
                if (hasPoliSci) {
                    processedResults = processedResults.filter(uni => uni.programs['Social Sciences'] > 0);
                }
                if (hasPreLaw) {
                    // "Pre-Law" is a track, not a specific major in this dataset. We use strong feeder programs as a proxy.
                    processedResults = processedResults.filter(uni => uni.programs['Social Sciences'] > 0 || uni.programs['Humanities'] > 0);
                }
                
                // RECOMMENDATION LOGIC
                processedResults.forEach(uni => {
                    uni.matchScore = calculateMatchScore(uni);
                });

                results = processedResults;
                document.getElementById('sort-by').value = 'matchScore'; // Reset sort dropdown to default
                sortResults();
                updateMap();

            } catch (error) {
                console.error("Search failed:", error);
                resultsDiv.innerHTML = `<p style="color: red;">Failed to fetch university data. ${error.message}. Please try again later.</p>`;
            }
        }
        
        function calculateMatchScore(uni) {
            let score = 0;
            // Enrollment: Prefers 15k-50k
            if (uni.enrollment >= 15000 && uni.enrollment <= 50000) score += 25;
            else if (uni.enrollment >= 10000) score += 10;
            
            // Selectivity: Prefers < 50%
            if (uni.acceptance < 0.5) score += 20;
            else if (uni.acceptance < 0.65) score += 5;
            
            // Location: Prefers Coastal
            if (coastalStates.includes(uni.state)) score += 15;
            
            // Academic Programs: Business, PoliSci, Pre-Law
            if (uni.programs['Business & Marketing'] > 0) score += 10;
            if (uni.programs['Social Sciences'] > 0) score += 10;
            if (uni.programs['Humanities'] > 0) score += 5; // Bonus for pre-law track diversity

            // Proxy for "Social Scene": Public, Urban/Suburban, decent SAT
            if (uni.ownership === 1) score += 10; // Public school
            if ([11, 12, 13, 21, 22, 23].includes(uni.locale)) score += 10; // City or Suburb
            if (uni.sat > 1200) score += 10;
            else if (uni.sat > 1100) score += 5;

            return score;
        }

        function getMatchStrength(score) {
            if (score > 90) return { text: 'PERFECT MATCH', class: 'match-perfect' };
            if (score > 75) return { text: 'STRONG MATCH', class: 'match-strong' };
            if (score > 60) return { text: 'GOOD MATCH', class: 'match-good' };
            return null;
        }

        const formatPercent = (val) => val !== null && val !== undefined ? `${(val * 100).toFixed(0)}%` : 'N/A';
        const formatCurrency = (val) => val !== null && val !== undefined ? `$${val.toLocaleString()}` : 'N/A';
        const formatNumber = (val) => val !== null && val !== undefined ? val.toLocaleString() : 'N/A';

        function sortResults() {
            const sortBy = document.getElementById('sort-by').value;

            results.sort((a, b) => {
                // Helper to push null/undefined values to the bottom of the list
                const handleNulls = (valA, valB) => {
                    if (valA === null || valA === undefined) return 1;
                    if (valB === null || valB === undefined) return -1;
                    return 0;
                };

                switch (sortBy) {
                    case 'matchScore':
                        return b.matchScore - a.matchScore;
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'acceptanceLow':
                        return handleNulls(a.acceptance, b.acceptance) || a.acceptance - b.acceptance;
                    case 'satHigh':
                        return handleNulls(a.sat, b.sat) || b.sat - a.sat;
                    case 'costLow':
                        return handleNulls(a.totalCostOutState, b.totalCostOutState) || a.totalCostOutState - b.totalCostOutState;
                    case 'costHigh':
                        return handleNulls(a.totalCostOutState, b.totalCostOutState) || b.totalCostOutState - a.totalCostOutState;
                    case 'enrollmentHigh':
                        return handleNulls(a.enrollment, b.enrollment) || b.enrollment - a.enrollment;
                    default:
                        return 0;
                }
            });

            showResults();
        }

        function showResults() {
            const sortContainer = document.querySelector('.sort-container');
            const resultsDiv = document.getElementById('results');
            let html = '';
            if (results.length === 0) {
                sortContainer.style.display = 'none';
                html = '<p>No universities found matching your criteria. Try adjusting your filters.</p>';
            } else {
                sortContainer.style.display = 'block';
                html = `<div style="margin-bottom:20px;padding:15px;background:#eef2ff;border-radius:8px;"><h3>Found ${results.length} universities</h3><p style="font-size:0.9rem; color:#555;">Displaying data for the ${latestYear-1}-${latestYear} academic year.</p></div>`;
                results.forEach((uni, i) => {
                    const match = getMatchStrength(uni.matchScore);
                    const matchBadge = match ? `<span class="match-badge ${match.class}">${match.text}</span>` : '';

                    html += `
                        <div class="university-card" onclick="showDetails(${i})">
                            <h4><span>${uni.name}</span> ${matchBadge}</h4>
                            <p><strong>Location:</strong> ${uni.location}</p>
                            <p><strong>Enrollment:</strong> ${formatNumber(uni.enrollment)}</p>
                            <p><strong>Acceptance Rate:</strong> ${formatPercent(uni.acceptance)}</p>
                            <p><strong>Avg SAT Score:</strong> ${formatNumber(uni.sat)}</p>
                            <button onclick="showDetails(${i}); event.stopPropagation();" class="btn" style="padding: 8px 15px;">View Details</button>
                            ${uni.website ? `<button onclick="openSite('${uni.website}'); event.stopPropagation();" class="btn" style="padding: 8px 15px;">Website</button>` : ''}
                        </div>`;
                });
            }
            resultsDiv.innerHTML = html;
        }

        function getLocale(code) {
            const locales = {
                11: 'City: Large', 12: 'City: Midsize', 13: 'City: Small',
                21: 'Suburb: Large', 22: 'Suburb: Midsize', 23: 'Suburb: Small',
                31: 'Town: Fringe', 32: 'Town: Distant', 33: 'Town: Remote',
                41: 'Rural: Fringe', 42: 'Rural: Distant', 43: 'Rural: Remote',
            };
            return locales[code] || 'N/A';
        }

        function getOwnership(code) {
            const ownerships = { 1: 'Public', 2: 'Private Nonprofit', 3: 'Private For-Profit' };
            return ownerships[code] || 'N/A';
        }

        function showDetails(index) {
            const uni = results[index];
            const match = getMatchStrength(uni.matchScore);
            const matchBadge = match ? `<span class="match-badge ${match.class}" style="font-size: 1rem; vertical-align: middle; margin-left: 15px;">${match.text}</span>` : '';
            let html = `<h2>${uni.name} ${matchBadge}</h2>`;

            html += `<div class="detail-section"><h3>Location & Campus Life</h3><p><strong>Location:</strong> ${uni.location}</p><p><strong>Setting:</strong> ${getLocale(uni.locale)}</p><p><strong>Type:</strong> ${getOwnership(uni.ownership)}</p></div>`;
            html += `<div class="detail-section"><h3>Enrollment & Acceptance</h3><p><strong>Undergraduate Enrollment:</strong> ${formatNumber(uni.enrollment)}</p><p><strong>Acceptance Rate:</strong> ${formatPercent(uni.acceptance)}</p><p><strong>Average SAT Score:</strong> ${formatNumber(uni.sat)}</p></div>`;
            
            const popularPrograms = Object.entries(uni.programs).filter(([_, v]) => v > 0).sort((a, b) => b[1] - a[1]).slice(0, 3).map(([name, value]) => `${name} (${formatPercent(value)})`).join(', ');
            html += `<div class="detail-section"><h3>Academics & Outcomes</h3><p><strong>Overall Graduation Rate:</strong> ${formatPercent(uni.gradRate)} <br><small>(For first-time, full-time students)</small></p><p><strong>Median Annual Earnings:</strong> ${formatCurrency(uni.medianEarnings)} <br><small>(6 years after entry)</small></p><p><strong>Popular Programs:</strong> ${popularPrograms || 'N/A'}</p></div>`;
            
            html += `<div class="detail-section"><h3>Costs & Financial Aid</h3><p><strong>Tuition (In-State):</strong> ${formatCurrency(uni.tuitionIn)}</p><p><strong>Tuition (Out-of-State):</strong> ${formatCurrency(uni.tuitionOut)}</p><p><strong>Estimated Total Cost (In-State):</strong> ${formatCurrency(uni.totalCostInState)}</p><p><strong>Estimated Total Cost (Out-of-State):</strong> ${formatCurrency(uni.totalCostOutState)}</p><small>Estimated total cost includes tuition, on-campus room & board, books, and other expenses.</small></div>`;

            if (uni.website) {
                html += `<button onclick="openSite('${uni.website}')" class="btn" style="margin-top: 20px;">Visit Website</button>`;
            }
            
            document.getElementById('modal-body').innerHTML = html;
            document.getElementById('modal').style.display = 'block';
        }

        function openSite(url) {
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'http://' + url;
            }
            window.open(url, '_blank');
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function clearFilters() {
            document.getElementById('name').value = '';
            document.getElementById('state').value = '';
            document.getElementById('city').value = '';
            document.getElementById('minEnroll').value = '';
            document.getElementById('maxEnroll').value = '';
            document.getElementById('maxAccept').value = '';
            document.getElementById('minSat').value = '';
            document.getElementById('maxTuitionIn').value = '';
            document.getElementById('maxTuitionOut').value = '';
            document.getElementById('maxTotalCost').value = '';
            document.getElementById('coastal').checked = false;
            document.getElementById('urban').checked = false;
            document.getElementById('suburban').checked = false;
            document.getElementById('business').checked = false;
            document.getElementById('politicalScience').checked = false;
            document.getElementById('preLaw').checked = false;
            document.querySelector('.sort-container').style.display = 'none';
            document.getElementById('results').innerHTML = '<p>Use the filters above and click "Search Universities" to find schools.</p>';
            results = [];
            updateMap();
        }

        function initMap() {
            try {
                map = L.map('map').setView([39.8283, -98.5795], 4);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                markersLayer.addTo(map);
            } catch (error) {
                document.getElementById('map').innerHTML = '<p>Error loading map.</p>';
            }
        }
        
        function updateMap() {
            markersLayer.clearLayers();
            if (results.length > 0) {
                const markers = [];
                results.forEach((uni, i) => {
                    const marker = L.marker([uni.lat, uni.lng]);
                    marker.bindPopup(`<h4>${uni.name}</h4><p>${uni.location}</p><a href="#" onclick="showDetails(${i}); return false;">View Details</a>`);
                    markers.push(marker);
                });
                markersLayer.addLayer(L.layerGroup(markers));
                map.fitBounds(L.featureGroup(markers).getBounds().pad(0.1));
            } else {
                 map.setView([39.8283, -98.5795], 4);
            }
        }

        window.onload = function() {
            initMap();
        };

        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>
</body>
</html>